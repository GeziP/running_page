<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Geziè·‘æ­¥æ•°æ®æ·±åº¦åˆ†æ - æ´»åŠ¨ç±»å‹ç»Ÿè®¡ã€è·ç¦»åˆ†å¸ƒã€é…é€Ÿè¶‹åŠ¿ã€ä¸ªäººæœ€ä½³è®°å½•">
    <meta name="keywords" content="è·‘æ­¥æ•°æ®,è¿åŠ¨åˆ†æ,é…é€Ÿåˆ†æ,è·ç¦»ç»Ÿè®¡,è¿åŠ¨å¯è§†åŒ–">
    <meta name="author" content="Gezi Running">
    <title>ğŸ“Š è¿åŠ¨æ•°æ®åˆ†æ - Gezi Running</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .loading {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- å¯¼èˆªæ  -->
    <nav class="gradient-bg text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">ğŸ“Š Gezi Running æ•°æ®åˆ†æ</h1>
            <div class="flex space-x-4">
                <button onclick="refreshData()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-colors">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>
                <a href="./" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                    â† è¿”å›ä¸»é¡µ
                </a>
            </div>
        </div>
    </nav>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 text-center">
            <div class="loading text-4xl mb-4">ğŸ“Š</div>
            <div class="text-lg font-semibold">æ­£åœ¨åŠ è½½åˆ†ææ•°æ®...</div>
            <div class="text-sm text-gray-600 mt-2">è¯·ç¨å€™</div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-gray-800 mb-4">ğŸƒâ€â™‚ï¸ è¿åŠ¨æ•°æ®æ·±åº¦åˆ†æ</h2>
            <p class="text-gray-600 text-lg">æ·±å…¥äº†è§£æ‚¨çš„è¿åŠ¨è¡¨ç°ï¼Œå‘ç°è¿åŠ¨è§„å¾‹å’Œè¶‹åŠ¿</p>
            <div id="last-updated" class="text-sm text-gray-500 mt-2"></div>
        </div>

        <!-- æ•°æ®æ¦‚è§ˆå¡ç‰‡ -->
        <div id="overview-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- åŠ¨æ€åŠ è½½ -->
        </div>

        <!-- æ´»åŠ¨ç±»å‹åˆ†å¸ƒ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 card-hover">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                ğŸƒâ€â™‚ï¸ æ´»åŠ¨ç±»å‹åˆ†å¸ƒ
            </h3>
            <div id="activity-types" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- è·ç¦»åˆ†å¸ƒå›¾è¡¨ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 card-hover">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                ğŸ“ è·ç¦»åˆ†å¸ƒåˆ†æ
            </h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <canvas id="distanceChart" width="400" height="300"></canvas>
                </div>
                <div id="distance-distribution" class="space-y-3">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>

        <!-- æ—¶é—´è¶‹åŠ¿åˆ†æ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 card-hover">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                ğŸ“ˆ æ—¶é—´è¶‹åŠ¿åˆ†æ
            </h3>
            <div class="mb-4">
                <select id="trend-period" class="bg-gray-50 border border-gray-300 rounded-lg px-3 py-2">
                    <option value="monthly">æŒ‰æœˆç»Ÿè®¡</option>
                    <option value="weekly">æŒ‰å‘¨ç»Ÿè®¡</option>
                    <option value="yearly">æŒ‰å¹´ç»Ÿè®¡</option>
                </select>
            </div>
            <canvas id="trendChart" width="800" height="400"></canvas>
        </div>

        <!-- ä¸ªäººæœ€ä½³è®°å½• -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 card-hover">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                ğŸ† ä¸ªäººæœ€ä½³è®°å½•
            </h3>
            <div id="personal-bests" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- æœˆåº¦ç›®æ ‡è¿½è¸ª -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 card-hover">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                ğŸ¯ æœˆåº¦ç›®æ ‡è¿½è¸ª
            </h3>
            <div id="monthly-goals" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- è¿åŠ¨çƒ­åŠ›å›¾ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 card-hover">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                ğŸ”¥ è¿åŠ¨æ´»è·ƒåº¦çƒ­åŠ›å›¾
            </h3>
            <div id="activity-heatmap" class="overflow-x-auto">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- è¯¦ç»†ç»Ÿè®¡è¡¨ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8 card-hover">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                ğŸ“‹ è¯¦ç»†ç»Ÿè®¡è¡¨
            </h3>
            <div class="overflow-x-auto">
                <table id="stats-table" class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left">ç»Ÿè®¡é¡¹ç›®</th>
                            <th class="px-4 py-2 text-left">æ•°å€¼</th>
                            <th class="px-4 py-2 text-left">å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table-body">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æ•°æ®ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="bg-gray-100 rounded-lg p-6 mb-8">
            <h3 class="text-lg font-semibold mb-2">ğŸ“ˆ æ•°æ®ç»Ÿè®¡ä¿¡æ¯</h3>
            <div id="data-info" class="text-sm text-gray-600">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨åˆ†ææ•°æ®
        let analysisData = {};
        let charts = {};

        // åŠ è½½åˆ†ææ•°æ®
        async function loadAnalysisData() {
            try {
                showLoading(true);
                
                // è°ƒè¯•ä¿¡æ¯
                console.log('å½“å‰é¡µé¢URL:', window.location.href);
                console.log('å°è¯•åŠ è½½æ•°æ®æ–‡ä»¶...');
                
                const urls = [
                    './static/analysis/analysis_overview.json',
                    './static/analysis/activity_types.json', 
                    './static/analysis/basic_statistics.json'
                ];
                
                urls.forEach(url => console.log('æ•°æ®æ–‡ä»¶URL:', new URL(url, window.location.href).href));
                
                const [overviewRes, typesRes, basicRes] = await Promise.allSettled([
                    fetch(urls[0]),
                    fetch(urls[1]),
                    fetch(urls[2])
                ]);

                if (overviewRes.status === 'fulfilled' && overviewRes.value.ok) {
                    analysisData.overview = await overviewRes.value.json();
                }

                if (typesRes.status === 'fulfilled' && typesRes.value.ok) {
                    analysisData.types = await typesRes.value.json();
                }

                if (basicRes.status === 'fulfilled' && basicRes.value.ok) {
                    analysisData.basic = await basicRes.value.json();
                }

                renderAnalysisData();
                showLoading(false);
            } catch (error) {
                console.error('åŠ è½½åˆ†ææ•°æ®å¤±è´¥:', error);
                showError(`æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
            }
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            showLoading(false);
            document.body.innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-gray-50">
                    <div class="text-center max-w-md mx-auto p-8 bg-white rounded-lg shadow-lg">
                        <div class="text-6xl mb-4">ğŸ˜“</div>
                        <h2 class="text-2xl font-bold text-red-600 mb-4">æ•°æ®åŠ è½½å¤±è´¥</h2>
                        <p class="text-gray-600 mb-6">å¯èƒ½çš„åŸå› ï¼šåˆ†ææ•°æ®å°šæœªç”Ÿæˆæˆ–æ–‡ä»¶è·¯å¾„ä¸æ­£ç¡®</p>
                        <div class="space-y-3">
                            <button onclick="window.location.reload()" 
                                    class="block w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                                ğŸ”„ é‡æ–°åŠ è½½
                            </button>
                            <a href="./" class="block w-full bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors font-medium text-decoration-none">
                                ğŸ  è¿”å›ä¸»é¡µ
                            </a>
                            <div class="text-sm text-gray-500 mt-4">
                                <p>ğŸ’¡ æç¤ºï¼šè¯·åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ</p>
                                <code class="bg-gray-100 px-2 py-1 rounded text-xs">python run_page/gen_analysis.py</code>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadAnalysisData();
        }

        // æ¸²æŸ“åˆ†ææ•°æ®
        function renderAnalysisData() {
            renderOverviewCards();
            renderActivityTypes();
            renderDistanceDistribution();
            renderDistanceChart();
            renderPersonalBests();
            renderMonthlyGoals();
            renderActivityHeatmap();
            renderStatsTable();
            renderDataInfo();
            updateLastUpdated();
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdated() {
            const lastUpdated = analysisData.overview?.generated_at;
            if (lastUpdated) {
                document.getElementById('last-updated').textContent = 
                    `æœ€åæ›´æ–°ï¼š${formatDateTime(lastUpdated)}`;
            }
        }

        // æ¸²æŸ“æ¦‚è§ˆå¡ç‰‡
        function renderOverviewCards() {
            const overview = analysisData.overview?.overview || {};
            const container = document.getElementById('overview-cards');
            
            const cards = [
                {
                    title: 'æ€»æ´»åŠ¨æ•°',
                    value: overview.total_activities || 0,
                    icon: 'ğŸ¯',
                    color: 'blue',
                    subtitle: 'æ¬¡è¿åŠ¨'
                },
                {
                    title: 'æ€»è·ç¦»',
                    value: (overview.total_distance_km || 0).toLocaleString(),
                    icon: 'ğŸ›£ï¸',
                    color: 'green',
                    subtitle: 'å…¬é‡Œ'
                },
                {
                    title: 'æ€»æ—¶é—´',
                    value: overview.total_time_formatted || '0:00',
                    icon: 'â±ï¸',
                    color: 'purple',
                    subtitle: 'è¿åŠ¨æ—¶é•¿'
                },
                {
                    title: 'å¹³å‡è·ç¦»',
                    value: (overview.avg_distance_per_activity || 0).toFixed(1),
                    icon: 'ğŸ“Š',
                    color: 'orange',
                    subtitle: 'å…¬é‡Œ/æ¬¡'
                }
            ];

            container.innerHTML = cards.map(card => `
                <div class="bg-white rounded-lg shadow-lg p-6 card-hover border-l-4 border-${card.color}-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm font-medium text-gray-600">${card.title}</div>
                            <div class="text-3xl font-bold text-${card.color}-600 mt-1">${card.value}</div>
                            <div class="text-xs text-gray-500 mt-1">${card.subtitle}</div>
                        </div>
                        <div class="text-4xl opacity-80">${card.icon}</div>
                    </div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“æ´»åŠ¨ç±»å‹
        function renderActivityTypes() {
            const typeStats = analysisData.types?.type_statistics || {};
            const container = document.getElementById('activity-types');
            
            const types = Object.entries(typeStats);
            if (types.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-3">æš‚æ— æ´»åŠ¨ç±»å‹æ•°æ®</p>';
                return;
            }

            container.innerHTML = types.map(([key, stats]) => `
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-6 text-center border border-gray-200">
                    <div class="text-4xl mb-3">${stats.icon}</div>
                    <div class="font-bold text-gray-800 text-lg">${stats.name}</div>
                    <div class="text-sm text-gray-600 mt-3 space-y-1">
                        <div class="flex justify-between">
                            <span>æ´»åŠ¨æ•°ï¼š</span>
                            <span class="font-semibold">${stats.count} æ¬¡</span>
                        </div>
                        <div class="flex justify-between">
                            <span>æ€»è·ç¦»ï¼š</span>
                            <span class="font-semibold">${stats.total_distance.toLocaleString()} å…¬é‡Œ</span>
                        </div>
                        <div class="flex justify-between">
                            <span>å æ¯”ï¼š</span>
                            <span class="font-semibold text-blue-600">${stats.percentage}%</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“è·ç¦»åˆ†å¸ƒ
        function renderDistanceDistribution() {
            const distData = analysisData.basic?.stats_by_type?.all?.distance_distribution;
            const container = document.getElementById('distance-distribution');
            
            if (!distData || !distData.distribution) {
                container.innerHTML = '<p class="text-gray-500">æš‚æ— è·ç¦»åˆ†å¸ƒæ•°æ®</p>';
                return;
            }

            const distribution = distData.distribution;
            const maxCount = Math.max(...Object.values(distribution).map(d => d.count));

            container.innerHTML = Object.entries(distribution).map(([range, data]) => {
                const percentage = maxCount > 0 ? (data.count / maxCount * 100) : 0;
                return `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-gray-800">${range}</span>
                            <span class="text-sm text-gray-600">${data.count} æ¬¡ (${data.percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-1000" 
                                 style="width: ${percentage}%"></div>
                        </div>
                        <div class="text-right text-sm font-medium text-blue-600">
                            ${data.total_distance.toLocaleString()} å…¬é‡Œ
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“è·ç¦»åˆ†å¸ƒå›¾è¡¨
        function renderDistanceChart() {
            const distData = analysisData.basic?.stats_by_type?.all?.distance_distribution;
            if (!distData || !distData.distribution) return;

            const ctx = document.getElementById('distanceChart');
            if (!ctx) return;

            const distribution = distData.distribution;
            const labels = Object.keys(distribution);
            const data = Object.values(distribution).map(d => d.count);
            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#F97316'];

            if (charts.distanceChart) {
                charts.distanceChart.destroy();
            }

            charts.distanceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        // æ¸²æŸ“ä¸ªäººæœ€ä½³è®°å½•
        function renderPersonalBests() {
            const records = analysisData.basic?.stats_by_type?.all?.personal_bests?.records;
            const container = document.getElementById('personal-bests');
            
            if (!records) {
                container.innerHTML = '<p class="text-gray-500 col-span-4">æš‚æ— ä¸ªäººæœ€ä½³è®°å½•</p>';
                return;
            }

            const recordsData = [
                {
                    key: 'longest_distance',
                    title: 'æœ€é•¿è·ç¦»',
                    icon: 'ğŸƒâ€â™‚ï¸',
                    value: records.longest_distance ? `${records.longest_distance.distance.toFixed(2)} å…¬é‡Œ` : '-',
                    activity: records.longest_distance?.activity,
                    color: 'blue'
                },
                {
                    key: 'longest_time',
                    title: 'æœ€é•¿æ—¶é—´',
                    icon: 'â±ï¸',
                    value: records.longest_time?.activity?.moving_time || '-',
                    activity: records.longest_time?.activity,
                    color: 'green'
                },
                {
                    key: 'fastest_pace',
                    title: 'æœ€å¿«é…é€Ÿ',
                    icon: 'âš¡',
                    value: records.fastest_pace ? formatPace(records.fastest_pace.pace) : '-',
                    activity: records.fastest_pace?.activity,
                    color: 'yellow'
                },
                {
                    key: 'highest_speed',
                    title: 'æœ€é«˜é€Ÿåº¦',
                    icon: 'ğŸš€',
                    value: records.highest_speed ? `${records.highest_speed.speed.toFixed(2)} å…¬é‡Œ/å°æ—¶` : '-',
                    activity: records.highest_speed?.activity,
                    color: 'red'
                }
            ];

            container.innerHTML = recordsData.map(record => `
                <div class="bg-gradient-to-br from-${record.color}-50 to-${record.color}-100 rounded-lg p-6 border border-${record.color}-200">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-bold text-gray-800">${record.title}</h4>
                        <div class="text-2xl">${record.icon}</div>
                    </div>
                    <div class="text-2xl font-bold text-${record.color}-600 mb-3">${record.value}</div>
                    ${record.activity ? `
                        <div class="text-sm text-gray-600 space-y-1">
                            <div class="flex items-center">
                                <span class="text-xs">ğŸ“…</span>
                                <span class="ml-1">${record.activity.start_date_local?.split('T')[0] || record.activity.start_date?.split(' ')[0] || ''}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-xs">ğŸ“</span>
                                <span class="ml-1 truncate">${record.activity.name || 'æœªå‘½åæ´»åŠ¨'}</span>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // æ¸²æŸ“æœˆåº¦ç›®æ ‡è¿½è¸ª
        function renderMonthlyGoals() {
            const overview = analysisData.overview?.overview || {};
            const container = document.getElementById('monthly-goals');
            
            // è®¡ç®—æœˆåº¦ç›®æ ‡ï¼ˆå‡è®¾ç›®æ ‡ï¼‰
            const monthlyDistanceGoal = 100; // 100å…¬é‡Œ/æœˆ
            const monthlyActivitiesGoal = 12; // 12æ¬¡/æœˆ
            
            const avgMonthlyDistance = overview.total_distance_km / 12 || 0; // å‡è®¾ä¸€å¹´æ•°æ®
            const avgMonthlyActivities = overview.total_activities / 12 || 0;
            
            const goals = [
                {
                    title: 'æœˆåº¦è·ç¦»ç›®æ ‡',
                    current: avgMonthlyDistance.toFixed(1),
                    target: monthlyDistanceGoal,
                    unit: 'å…¬é‡Œ',
                    icon: 'ğŸ¯',
                    color: 'blue'
                },
                {
                    title: 'æœˆåº¦æ´»åŠ¨ç›®æ ‡',
                    current: Math.round(avgMonthlyActivities),
                    target: monthlyActivitiesGoal,
                    unit: 'æ¬¡',
                    icon: 'ğŸ“ˆ',
                    color: 'green'
                },
                {
                    title: 'å¹³å‡é…é€Ÿç›®æ ‡',
                    current: overview.avg_time_per_activity || '0:00',
                    target: '1:10:00',
                    unit: '',
                    icon: 'âš¡',
                    color: 'purple'
                }
            ];

            container.innerHTML = goals.map(goal => {
                const progress = typeof goal.current === 'number' ? 
                    Math.min((goal.current / goal.target) * 100, 100) : 50;
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-semibold text-gray-800">${goal.title}</h4>
                            <div class="text-2xl">${goal.icon}</div>
                        </div>
                        <div class="mb-4">
                            <div class="flex justify-between text-sm mb-2">
                                <span>å½“å‰: ${goal.current} ${goal.unit}</span>
                                <span>ç›®æ ‡: ${goal.target} ${goal.unit}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-${goal.color}-500 h-3 rounded-full transition-all duration-1000" 
                                     style="width: ${progress}%"></div>
                            </div>
                        </div>
                        <div class="text-center text-sm font-medium text-${goal.color}-600">
                            ${progress.toFixed(1)}% å®Œæˆ
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“æ´»åŠ¨çƒ­åŠ›å›¾
        function renderActivityHeatmap() {
            const container = document.getElementById('activity-heatmap');
            
            // ç”Ÿæˆç®€å•çš„å‘¨æ´»åŠ¨çƒ­åŠ›å›¾
            const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
            const timeSlots = ['06:00', '08:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00'];
            
            // æ¨¡æ‹Ÿæ•°æ®
            const heatmapData = weekdays.map(day => 
                timeSlots.map(time => Math.floor(Math.random() * 10))
            );

            let html = `
                <div class="text-center mb-4">
                    <h4 class="font-semibold text-gray-700">è¿åŠ¨æ—¶é—´åå¥½çƒ­åŠ›å›¾</h4>
                    <p class="text-sm text-gray-500">é¢œè‰²è¶Šæ·±è¡¨ç¤ºè¯¥æ—¶é—´æ®µè¿åŠ¨é¢‘æ¬¡è¶Šé«˜</p>
                </div>
                <div class="inline-block">
                    <div class="grid grid-cols-9 gap-1 text-xs">
                        <div></div>
            `;
            
            // æ—¶é—´æ ‡ç­¾
            timeSlots.forEach(time => {
                html += `<div class="text-center text-gray-600 p-2">${time}</div>`;
            });
            
            // æ•°æ®å•å…ƒæ ¼
            weekdays.forEach((day, dayIndex) => {
                html += `<div class="text-right text-gray-600 p-2">${day}</div>`;
                timeSlots.forEach((time, timeIndex) => {
                    const intensity = heatmapData[dayIndex][timeIndex];
                    const opacity = intensity / 10;
                    html += `
                        <div class="w-8 h-8 rounded border border-gray-200 flex items-center justify-center text-xs"
                             style="background-color: rgba(59, 130, 246, ${opacity})"
                             title="${day} ${time}: ${intensity} æ¬¡æ´»åŠ¨">
                            ${intensity || ''}
                        </div>
                    `;
                });
            });
            
            html += `
                    </div>
                    <div class="flex items-center justify-center mt-4 space-x-2 text-xs text-gray-600">
                        <span>å°‘</span>
                        <div class="flex space-x-1">
                            <div class="w-3 h-3 rounded border" style="background-color: rgba(59, 130, 246, 0.1)"></div>
                            <div class="w-3 h-3 rounded border" style="background-color: rgba(59, 130, 246, 0.3)"></div>
                            <div class="w-3 h-3 rounded border" style="background-color: rgba(59, 130, 246, 0.6)"></div>
                            <div class="w-3 h-3 rounded border" style="background-color: rgba(59, 130, 246, 0.9)"></div>
                        </div>
                        <span>å¤š</span>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // æ¸²æŸ“ç»Ÿè®¡è¡¨
        function renderStatsTable() {
            const overview = analysisData.overview?.overview || {};
            const records = analysisData.basic?.stats_by_type?.all?.personal_bests?.records || {};
            const tbody = document.getElementById('stats-table-body');
            
            const stats = [
                ['æ€»æ´»åŠ¨æ•°', `${overview.total_activities || 0} æ¬¡`, 'æ‰€æœ‰è®°å½•çš„æ´»åŠ¨æ€»æ•°'],
                ['æ€»è·ç¦»', `${(overview.total_distance_km || 0).toLocaleString()} å…¬é‡Œ`, 'ç´¯è®¡è¿åŠ¨è·ç¦»'],
                ['æ€»æ—¶é—´', overview.total_time_formatted || '0:00', 'ç´¯è®¡è¿åŠ¨æ—¶é—´'],
                ['å¹³å‡è·ç¦»', `${(overview.avg_distance_per_activity || 0).toFixed(1)} å…¬é‡Œ`, 'æ¯æ¬¡æ´»åŠ¨å¹³å‡è·ç¦»'],
                ['å¹³å‡æ—¶é—´', overview.avg_time_per_activity || '0:00', 'æ¯æ¬¡æ´»åŠ¨å¹³å‡æ—¶é—´'],
                ['æœ€é•¿è·ç¦»', records.longest_distance ? `${records.longest_distance.distance.toFixed(2)} å…¬é‡Œ` : '-', 'å•æ¬¡æœ€é•¿è·ç¦»è®°å½•'],
                ['æœ€é•¿æ—¶é—´', records.longest_time?.activity?.moving_time || '-', 'å•æ¬¡æœ€é•¿æ—¶é—´è®°å½•'],
                ['æœ€å¿«é…é€Ÿ', records.fastest_pace ? formatPace(records.fastest_pace.pace) : '-', 'æœ€å¿«é…é€Ÿè®°å½•'],
                ['æœ€é«˜é€Ÿåº¦', records.highest_speed ? `${records.highest_speed.speed.toFixed(2)} å…¬é‡Œ/å°æ—¶` : '-', 'æœ€é«˜é€Ÿåº¦è®°å½•']
            ];

            tbody.innerHTML = stats.map((row, index) => `
                <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                    <td class="px-4 py-3 font-medium">${row[0]}</td>
                    <td class="px-4 py-3 text-blue-600 font-semibold">${row[1]}</td>
                    <td class="px-4 py-3 text-gray-600">${row[2]}</td>
                </tr>
            `).join('');
        }

        // æ¸²æŸ“æ•°æ®ç»Ÿè®¡ä¿¡æ¯
        function renderDataInfo() {
            const overview = analysisData.overview;
            const types = analysisData.types;
            const container = document.getElementById('data-info');
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <div><strong>æ•°æ®ç”Ÿæˆæ—¶é—´:</strong> ${formatDateTime(overview?.generated_at)}</div>
                        <div><strong>æ€»æ´»åŠ¨è®°å½•:</strong> ${types?.total_activities || 0} æ¡</div>
                        <div><strong>å¯ç”¨æ´»åŠ¨ç±»å‹:</strong> ${types?.available_types?.join(', ') || 'æ— '}</div>
                    </div>
                    <div class="space-y-2">
                        <div><strong>æ•°æ®æ¥æº:</strong> è¿åŠ¨æ•°æ®åº“ (data.db)</div>
                        <div><strong>åˆ†ææ¨¡å—ç‰ˆæœ¬:</strong> v1.0.0</div>
                        <div><strong>æ”¯æŒçš„åˆ†æç±»å‹:</strong> è·ç¦»ã€æ—¶é—´ã€é…é€Ÿã€å¿ƒç‡</div>
                    </div>
                </div>
            `;
        }

        // å·¥å…·å‡½æ•°
        function formatPace(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}/å…¬é‡Œ`;
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return 'æœªçŸ¥';
            try {
                return new Date(dateStr).toLocaleString('zh-CN');
            } catch {
                return dateStr;
            }
        }

        // é¡µé¢åŠ è½½åæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalysisData();
        });
    </script>
</body>
</html> 